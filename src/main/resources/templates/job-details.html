<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${jobName} + ' - Execution History'">Job Executions</title>
  <link rel="stylesheet" href="/webjars/bootstrap/5.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    .table-success { background-color: #d4edda; }
    .table-danger { background-color: #f8d7da; }
    .pagination-info { 
      font-size: 0.9rem; 
      color: #6c757d; 
    }
    .search-controls {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .job-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 0;
      border-radius: 10px;
      margin-bottom: 2rem;
    }
    .stats-card {
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }
    .stats-card:hover {
      transform: translateY(-2px);
    }
    .table-responsive {
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .error-message {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .error-tooltip {
      cursor: help;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <!-- Job Header -->
  <div class="job-header text-center">
    <h1 class="mb-2" th:text="${jobName} + ' - Execution History'">Job Executions</h1>
    <p class="mb-0">
      <a href="/job-monitor/ui" class="text-white text-decoration-none">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
      </a>
    </p>
  </div>

  <!-- Summary Statistics -->
  <div class="row mb-4" th:if="${logs != null and !logs.isEmpty()}">
    <div class="col-md-4 mb-3">
      <div class="card stats-card">
        <div class="card-body text-center">
          <i class="bi bi-list-ul text-primary mb-2" style="font-size: 2rem;"></i>
          <h5 class="card-title">Total Executions</h5>
          <h3 class="text-primary" th:text="${page != null ? page.totalElements : #lists.size(logs)}">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card stats-card">
        <div class="card-body text-center">
          <i class="bi bi-check-circle text-success mb-2" style="font-size: 2rem;"></i>
          <h5 class="card-title">Successful</h5>
          <h3 class="text-success" th:text="${#lists.size(logs.?[success])}">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card stats-card">
        <div class="card-body text-center">
          <i class="bi bi-x-circle text-danger mb-2" style="font-size: 2rem;"></i>
          <h5 class="card-title">Failed</h5>
          <h3 class="text-danger" th:text="${#lists.size(logs.?[!success])}">0</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination Controls and Search (if paginated) -->
  <div class="search-controls" th:if="${page != null}">
    <form method="get" class="row g-3">
      <div class="col-md-3">
        <label for="size" class="form-label">Items per page</label>
        <select id="size" name="size" class="form-select" onchange="this.form.submit()">
          <option value="10" th:selected="${page.pageSize == 10}">10</option>
          <option value="20" th:selected="${page.pageSize == 20}">20</option>
          <option value="50" th:selected="${page.pageSize == 50}">50</option>
          <option value="100" th:selected="${page.pageSize == 100}">100</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="sort" class="form-label">Sort by</label>
        <select id="sort" name="sort" class="form-select" onchange="this.form.submit()">
          <option value="start_time" th:selected="${currentSort == 'start_time'}">Start Time</option>
          <option value="end_time" th:selected="${currentSort == 'end_time'}">End Time</option>
          <option value="duration_ms" th:selected="${currentSort == 'duration_ms'}">Duration</option>
          <option value="success" th:selected="${currentSort == 'success'}">Status</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="direction" class="form-label">Direction</label>
        <select id="direction" name="direction" class="form-select" onchange="this.form.submit()">
          <option value="DESC" th:selected="${currentDirection == 'DESC'}">Descending</option>
          <option value="ASC" th:selected="${currentDirection == 'ASC'}">Ascending</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <a th:href="@{/job-monitor/ui/{jobName}(jobName=${jobName})}" 
           class="btn btn-outline-secondary">
          <i class="bi bi-arrow-clockwise"></i> Reset
        </a>
      </div>
      <input type="hidden" name="page" th:value="${page.pageNumber}" />
    </form>
  </div>

  <!-- Pagination Info -->
  <div class="d-flex justify-content-between align-items-center mb-3" th:if="${page != null}">
    <div class="pagination-info">
      Showing <span th:text="${page.pageNumber * page.pageSize + 1}">1</span>
      to <span th:text="${page.pageNumber * page.pageSize + #lists.size(page.content)}">10</span>
      of <span th:text="${page.totalElements}">100</span> entries
    </div>
    
    <!-- Enable Pagination Toggle -->
    <div th:if="${page == null}">
      <a th:href="@{/job-monitor/ui/{jobName}(jobName=${jobName}, page=0, size=20)}" 
         class="btn btn-sm btn-primary">
        <i class="bi bi-list"></i> Enable Pagination
      </a>
    </div>
  </div>

  <!-- Data Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
      <tr>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Duration</th>
        <th>Status</th>
        <th>Error Message</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="log : ${logs}"
          th:classappend="${log.success} ? 'table-success' : 'table-danger'">
        <td th:text="${#temporals.format(log.startTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
        <td th:text="${#temporals.format(log.endTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
        <td>
          <span th:text="${log.durationMs >= 60000 ? (log.durationMs / 60000) + 'm ' + ((log.durationMs % 60000) / 1000) + 's' : (log.durationMs / 1000) + 's'}"></span>
          <small class="text-muted" th:text="'(' + ${log.durationMs} + 'ms)'"></small>
        </td>
        <td>
          <span th:if="${log.success}" class="badge bg-success">
            <i class="bi bi-check-circle"></i> Success
          </span>
          <span th:if="${!log.success}" class="badge bg-danger">
            <i class="bi bi-x-circle"></i> Failed
          </span>
        </td>
        <td>
          <span th:if="${log.errorMessage != null}" 
                class="error-message error-tooltip" 
                th:text="${log.errorMessage}"
                th:title="${log.errorMessage}"></span>
          <span th:if="${log.errorMessage == null}" class="text-muted">None</span>
        </td>
      </tr>
      <tr th:if="${logs.isEmpty()}">
        <td colspan="5" class="text-center text-muted py-4">
          <i class="bi bi-inbox" style="font-size: 3rem;"></i><br>
          No execution logs found for this job.
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination Navigation -->
  <nav aria-label="Job logs pagination" th:if="${page != null and page.totalPages > 1}">
    <div class="row">
      <div class="col-md-6">
        <ul class="pagination">
          <!-- Previous Page -->
          <li class="page-item" th:classappend="${!page.hasPrevious} ? 'disabled'">
            <a class="page-link" 
               th:href="${page.hasPrevious} ? @{/job-monitor/ui/{jobName}(jobName=${jobName}, page=${page.pageNumber - 1}, size=${page.pageSize}, sort=${currentSort}, direction=${currentDirection})} : '#'"
               aria-label="Previous">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
          
          <!-- Page Numbers -->
          <li class="page-item" 
              th:each="pageNum : ${#numbers.sequence(T(java.lang.Math).max(0, page.pageNumber - 2), T(java.lang.Math).min(page.totalPages - 1, page.pageNumber + 2))}"
              th:classappend="${pageNum == page.pageNumber} ? 'active'">
            <a class="page-link" 
               th:href="@{/job-monitor/ui/{jobName}(jobName=${jobName}, page=${pageNum}, size=${page.pageSize}, sort=${currentSort}, direction=${currentDirection})}"
               th:text="${pageNum + 1}">1</a>
          </li>
          
          <!-- Next Page -->
          <li class="page-item" th:classappend="${!page.hasNext} ? 'disabled'">
            <a class="page-link" 
               th:href="${page.hasNext} ? @{/job-monitor/ui/{jobName}(jobName=${jobName}, page=${page.pageNumber + 1}, size=${page.pageSize}, sort=${currentSort}, direction=${currentDirection})} : '#'"
               aria-label="Next">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        </ul>
      </div>
      <div class="col-md-6 d-flex justify-content-end align-items-center">
        <div class="pagination-info">
          Page <span th:text="${page.pageNumber + 1}">1</span> of <span th:text="${page.totalPages}">10</span>
        </div>
      </div>
    </div>
  </nav>

</div>

<script src="/webjars/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
// Initialize tooltips for error messages
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], .error-tooltip'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })
});
</script>
</body>
</html>
